language: python
python:
  - "3.5"
services:
  - docker
git:
  depth: false
branches:
  only:
  - master
  - develop
install:
  # Install Conda
  - sudo apt-get update
  - wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
  - bash miniconda.sh -b -p $HOME/miniconda
  - export PATH="$HOME/miniconda/bin:$PATH"
  - hash -r
  - conda config --set always_yes yes --set changeps1 no
  - conda update -q conda
  - conda info -a
  # Install crypr
  - mv .env_template .env
  - make create_environment
  - source activate crypto-predict
  - make requirements
  - python ./scripts/data/make_dataset.py --hours 1000
  - python ./scripts/features/make_features.py
  - python ./scripts/models/make_train_models.py --epochs 1
  # Deploy crypr API
  - docker build -f ./docker/Dockerfile -t crypr-api .
  - CONTAINER_ID=$(docker run -d -p 5000:5000 crypr-api)
  - sh ./docker/wait_for_healthy.sh $CONTAINER_ID
script:
  - docker ps | grep -q crypr-api
  - coverage run --source=crypr setup.py test
after_success:
  - coveralls
